<html>
<head>
<title>Orderbook</title>

<style>

tr.pairName td {
  font-weight: bold;
}

td {
  vertical-align: text-top;
  padding: 0.3em;
  min-width: 300px;
}

td.bids {
  border: 1px solid blue;
  color: blue;
}

td.asks{
  border: 1px solid red;
  color: red;
}

td.debug{
  min-width:250px;
  border: 1px solid black;
}
</style>

<script src="https://cdn.ethers.io/scripts/ethers-v4.min.js"
        charset="utf-8"
        type="text/javascript">
</script>



<script>

let btn0 = document.createElement("button")
btn0.innerHTML= "POPULATE"

let pairtoks = {}
let orderbook = {}
let rows = {}

function populate() {
    let popget = new XMLHttpRequest()

    this.innerHTML = "POPULATING..."
    this.disabled = true

    popget.onreadystatechange = function() {
      if (this.readyState == 4) {
        btn0.innerHTML = "POPULATE AGAIN"
        btn0.disabled = false
      }
    }

    popget.open("GET", "/api/populate")
    popget.send()
}

function add_order(pricepoint, amount, pair, side) {
  let amountPrecisionMultiplier = 1e6
  let pricePrecisionMultiplier = 1e6
  let amountMultiplier = ethers.utils.bigNumberify('1000000000000000000') //1e18
  let priceMultiplier = ethers.utils.bigNumberify('1000000') //1e6

  amount = ethers.utils.bigNumberify(amount)
    .mul(ethers.utils.bigNumberify(amountPrecisionMultiplier))
    .div(amountMultiplier)
  amount = amount.toString()/amountPrecisionMultiplier

  price = ethers.utils.bigNumberify(pricepoint)
    .mul(ethers.utils.bigNumberify(pricePrecisionMultiplier))
    .div(priceMultiplier)
  price = price.toString()/pricePrecisionMultiplier

  let cancelreq = new XMLHttpRequest()
  let params = [ "amount="+amount,
    "price="+price,
    "side="+side,
    "baseTokenAddress="+pairtoks[pair].base,
    "quoteTokenAddress="+pairtoks[pair].quote]
  cancelreq.open("GET", "/api/addorder?"+params.join("&"))
  cancelreq.send()
}

function cancel_order(hash) {
  let cancelreq = new XMLHttpRequest()

  cancelreq.open("GET", "/api/cancel?hash="+hash)
  cancelreq.send()
}

function onload() {
  btn0.onclick = populate

  var btn1 = document.createElement("button")
  btn1.innerHTML= "CANCEL ALL"

  btn1.onclick = function() {
    let popget = new XMLHttpRequest()
    popget.open("GET", "/api/cancelall")
    popget.send()
  }

  document.body.appendChild(btn0)
  document.body.appendChild(btn1)

  let pairreq = new XMLHttpRequest()

  pairreq.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      let tbl = document.createElement("table")
      document.body.appendChild(tbl)

      let data = JSON.parse(this.responseText)

      pairtoks = data.reduce( (tot, ele) => {
        tot[ele.baseTokenSymbol+"/"+ele.quoteTokenSymbol] = {base: ele.baseTokenAddress, quote: ele.quoteTokenAddress}
        return tot
      }, {})

      let ws = new WebSocket("ws://52.78.227.253:8081/socket")
      let ob = {}

      ws.onmessage = ev => {
        let data = JSON.parse(ev.data)
        if(data.channel && data.channel == "raw_orderbook"){
          data = data.event && data.event.payload
          if (data!=null){
            let pr = data[0].pairName
            data.forEach(ele => {
              orderbook[ele.hash] = ele
            })

            let acts = ["BUY", "SELL"]
            acts.forEach( (name, ind) => {
              rows[pr].cells[2+ind].innerHTML = ""
              let ords = Object.values(orderbook).filter(ele=>ele.side==name && ele.pairName == pr && ele.status!="CANCELLED" && ele.status!="FILLED")
                  .sort( (a,b) => (parseInt(a.pricepoint) > parseInt(b.pricepoint)) ? 1 : -1)
              if (name=='BUY') ords.reverse()

              let pricepoint = 1, amount = 1
              if (ords.length>0) {
                pricepoint = ords[0].pricepoint
                amount = ords[0].amount
              }

              let btn = document.createElement("button")
              btn.onclick = () => add_order(pricepoint, amount, pr, name=="BUY" ? "SELL" : "BUY")
              btn.innerHTML = "add: "+pricepoint+" "+amount
              rows['header'+pr].cells[ind].innerHTML = pr
              rows['header'+pr].cells[ind].appendChild(document.createElement("br"))
              rows['header'+pr].cells[ind].appendChild(btn)
              rows['header'+pr].cells[ind].appendChild(document.createElement("br"))

              ords.forEach( ele => {
                let btn = document.createElement("button")
                btn.innerHTML = "cancel: "+ele.pricepoint+" "+ele.amount
                btn.onclick = () => { cancel_order(ele.hash) }
                rows[pr].cells[2+ind].appendChild(btn)
                rows[pr].cells[2+ind].appendChild(document.createElement("br"))
              })
            })
          }
        } else if(data.channel && data.channel == "orderbook"){
          data = data.event && data.event.payload

          if(data.asks!=null && data.bids!=null) {
            ["bids", "asks"].forEach( (name,icell) => {
              let pair = data.pair
  
              data[name].forEach( ele => {
                if( ele.amount == "0")
                  delete ob[pair][name][ele.pricepoint]
                else
                  ob[pair][name][ele.pricepoint] = ele.amount
              })
              let line = Object.keys(ob[pair][name]).sort( (a,b) => name==="asks" ? a-b : b-a)
                .map( price => 'price: '+price+', amount: '+ob[pair][name][price] )
                .join("<br>")
  
              rows[pair].cells[icell].innerHTML = line
            })
          }
        }
      }
 

      data.filter( ele => ele.quoteTokenSymbol==="WETH" )
        .forEach( ele => {
          let pairName = ele.baseTokenSymbol+"/"+ele.quoteTokenSymbol

          let row = tbl.insertRow()
          row.className = "pairName"
          row.insertCell().innerHTML = pairName
          row.insertCell().innerHTML = pairName
          rows["header"+pairName] = row

          rows[pairName] = tbl.insertRow()
         
          rows[pairName].insertCell().className = 'bids'
          rows[pairName].insertCell().className = 'asks'
          rows[pairName].insertCell().className = 'debug'
          rows[pairName].insertCell().className = 'debug'

          ob[pairName] = {asks: {}, bids: {}}

          ws.addEventListener("open", _ => {
            ws.send(JSON.stringify({
              "channel": "orderbook",
              "event": {
                "type": "SUBSCRIBE",
                "payload": {
                  "baseToken": ele.baseTokenAddress,
                  "quoteToken": ele.quoteTokenAddress,
                }
              }
            }))
            ws.send(JSON.stringify({
              "channel": "raw_orderbook",
              "event": {
                "type": "SUBSCRIBE",
                "payload": {
                  "baseToken": ele.baseTokenAddress,
                  "quoteToken": ele.quoteTokenAddress,
                }
              }
            }))
          })
     })
    }
  }

  pairreq.open("GET", "/api/pairs")
  pairreq.send()
}

</script>

</head>

<body onload=onload()>

</body>
</html>
